{% extends "base.html" %}

{% block title %}Settings - Ultra-Turbo AppData Cleaner{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="bi bi-gear"></i>
            Application Settings
            <small class="text-muted fs-6">Configure cleaning behavior</small>
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Scan Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-search"></i>
                    Scan Settings
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="scan-paths" class="form-label">Default Scan Paths</label>
                    <textarea class="form-control" id="scan-paths" rows="4" 
                              placeholder="One path per line">{% for path in settings.scan_paths %}{{ path }}&#10;{% endfor %}</textarea>
                    <div class="form-text">Directories to scan by default. Use environment variables like %TEMP%.</div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="max-file-age" class="form-label">Max File Age (days)</label>
                            <input type="number" class="form-control" id="max-file-age" 
                                   value="{{ settings.max_file_age_days }}" min="1" max="365">
                            <div class="form-text">Only consider files older than this many days.</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="min-file-size" class="form-label">Min File Size (MB)</label>
                            <input type="number" class="form-control" id="min-file-size" 
                                   value="{{ settings.min_file_size_mb }}" min="0.1" max="100" step="0.1">
                            <div class="form-text">Ignore files smaller than this size.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Safety Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-shield-check"></i>
                    Safety & Backup Settings
                </h5>
            </div>
            <div class="card-body">
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="safe-mode" 
                           {% if settings.safe_mode %}checked{% endif %}>
                    <label class="form-check-label" for="safe-mode">
                        <strong>Safe Mode</strong> - Only clean files marked as very safe
                    </label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="backup-enabled" 
                           {% if settings.backup_enabled %}checked{% endif %}>
                    <label class="form-check-label" for="backup-enabled">
                        <strong>Auto Backup</strong> - Create backup before cleaning operations
                    </label>
                </div>
                
                <div class="mb-3">
                    <label for="backup-path" class="form-label">Backup Directory</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="backup-path" 
                               value="{{ settings.get('backup_path', '') }}" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="selectBackupPath()">
                            <i class="bi bi-folder"></i> Browse
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Interface Settings -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-palette"></i>
                    Interface Settings
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="theme-select" class="form-label">Theme</label>
                            <select class="form-select" id="theme-select" onchange="changeTheme()">
                                <option value="dark">Dark Theme</option>
                                <option value="light">Light Theme</option>
                                <option value="auto">Auto (System)</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="language-select" class="form-label">Language</label>
                            <select class="form-select" id="language-select">
                                <option value="en_US">English</option>
                                <option value="ro_RO" {% if settings.get('language') == 'ro_RO' %}selected{% endif %}>Română</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="confirmation-dialogs" 
                           {% if settings.get('confirmation_dialogs', True) %}checked{% endif %}>
                    <label class="form-check-label" for="confirmation-dialogs">
                        Show confirmation dialogs
                    </label>
                </div>
                
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                    <label class="form-check-label" for="auto-refresh">
                        Auto-refresh system statistics
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="saveSettings()">
                        <i class="bi bi-check-circle"></i>
                        Save Settings
                    </button>
                    <button class="btn btn-outline-secondary" onclick="resetSettings()">
                        <i class="bi bi-arrow-counterclockwise"></i>
                        Reset to Defaults
                    </button>
                    <button class="btn btn-outline-info" onclick="exportSettings()">
                        <i class="bi bi-download"></i>
                        Export Settings
                    </button>
                    <button class="btn btn-outline-warning" onclick="importSettings()">
                        <i class="bi bi-upload"></i>
                        Import Settings
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Settings Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-info-circle"></i>
                    Settings Info
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Config File:</strong>
                    <code class="small d-block mt-1">~/.ultra_turbo_cleaner/config.json</code>
                </div>
                
                <div class="mb-3">
                    <strong>Backup Location:</strong>
                    <code class="small d-block mt-1">{{ settings.get('backup_path', 'Not set') }}</code>
                </div>
                
                <div class="mb-3">
                    <strong>Last Modified:</strong>
                    <span class="small" id="last-modified">Unknown</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="testScanPaths()">
                        <i class="bi bi-check-circle"></i>
                        Test Scan Paths
                    </button>
                    <button class="btn btn-outline-info" onclick="checkBackupSpace()">
                        <i class="bi bi-hdd"></i>
                        Check Backup Space
                    </button>
                    <button class="btn btn-outline-warning" onclick="cleanOldBackups()">
                        <i class="bi bi-trash"></i>
                        Clean Old Backups
                    </button>
                </div>
            </div>
        </div>
        
        <!-- System Status -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-cpu"></i>
                    System Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Memory:</span>
                        <span id="current-memory">{{ system_info.memory.percentage }}%</span>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-primary" style="width: {{ system_info.memory.percentage }}%"></div>
                    </div>
                </div>
                
                <div class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>Disk:</span>
                        <span id="current-disk">{{ system_info.disk.percentage }}%</span>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar bg-info" style="width: {{ system_info.disk.percentage }}%"></div>
                    </div>
                </div>
                
                <div class="small text-muted text-center mt-3">
                    <i class="bi bi-clock"></i>
                    Last updated: <span id="status-last-updated">Now</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize settings page
    document.addEventListener('DOMContentLoaded', function() {
        initializeSettings();
        loadCurrentSettings();
    });
    
    function saveSettings() {
        const settings = {
            scan_paths: document.getElementById('scan-paths').value.split('\n').filter(p => p.trim()),
            max_file_age_days: parseInt(document.getElementById('max-file-age').value),
            min_file_size_mb: parseFloat(document.getElementById('min-file-size').value),
            safe_mode: document.getElementById('safe-mode').checked,
            backup_enabled: document.getElementById('backup-enabled').checked,
            confirmation_dialogs: document.getElementById('confirmation-dialogs').checked
        };
        
        fetch('/api/settings', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(settings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                showNotification('Error saving settings: ' + data.error, 'danger');
            } else {
                showNotification('Settings saved successfully!', 'success');
            }
        })
        .catch(error => {
            showNotification('Network error: ' + error, 'danger');
        });
    }
    
    function resetSettings() {
        if (confirm('Are you sure you want to reset all settings to defaults?')) {
            // Reset form to defaults
            document.getElementById('scan-paths').value = 
                '%APPDATA%\n%LOCALAPPDATA%\n%TEMP%\nC:\\\\Windows\\\\Temp';
            document.getElementById('max-file-age').value = '30';
            document.getElementById('min-file-size').value = '1';
            document.getElementById('safe-mode').checked = true;
            document.getElementById('backup-enabled').checked = true;
            document.getElementById('confirmation-dialogs').checked = true;
            
            saveSettings();
        }
    }
    
    function testScanPaths() {
        showNotification('Testing scan paths...', 'info');
        // TODO: Implement scan path testing
    }
    
    function checkBackupSpace() {
        showNotification('Checking backup space...', 'info');
        // TODO: Implement backup space check
    }
    
    function cleanOldBackups() {
        if (confirm('Clean backups older than 30 days?')) {
            showNotification('Cleaning old backups...', 'info');
            // TODO: Implement old backup cleaning
        }
    }
    
    function loadCurrentSettings() {
        fetch('/api/settings')
        .then(response => response.json())
        .then(settings => {
            if (!settings.error) {
                document.getElementById('scan-paths').value = settings.scan_paths.join('\n');
                document.getElementById('max-file-age').value = settings.max_file_age_days;
                document.getElementById('min-file-size').value = settings.min_file_size_mb;
                document.getElementById('safe-mode').checked = settings.safe_mode;
                document.getElementById('backup-enabled').checked = settings.backup_enabled;
            }
        })
        .catch(error => {
            console.error('Error loading settings:', error);
        });
    }
</script>
{% endblock %}